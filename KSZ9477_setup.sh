#!/bin/bash

# set -x
# trap read debug

trap 'exit -1' err

# should print 0x00 0x94 0x77
i2ctransfer -y 8 w2@0x5F 0x00 0x00 r3

# errata 1, config phy mmd
# todo: all ports
# https://microchipsupport.force.com/s/article/KSZ9897-Family-PHY-MMD-Register-Access-Example
# 0x01 0x6F 0xDD0B
# 0x01 0x8F 0x6032
# 0x01 0x9D 0x248C
# 0x01 0x75 0x0060
# 0x01 0xD3 0x7777
# 0x1C 0x06 0x3008
# 0x1C 0x08 0x2001

# port 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x6F # reg 6F
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0xDD 0x0B # DD0B

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x8F # reg 8F
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x60 0x32 # 6032

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x9D # reg 9D
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x24 0x8C # 248C

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x75 # reg 75
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x60 # 0060

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0xD3 # reg D3
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x77 0x77 # 7777

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x06 # reg 06
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x30 0x08 # 3008

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x08 # reg 08
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x20 0x01 # 2001

# port 2
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x6F # reg 6F
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0xDD 0x0B # DD0B

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x8F # reg 8F
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x60 0x32 # 6032

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x9D # reg 9D
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x24 0x8C # 248C

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x75 # reg 75
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x60 # 0060

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0xD3 # reg D3
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x01 # MMD 1
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x77 0x77 # 7777

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x06 # reg 06
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x30 0x08 # 3008

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x08 # reg 08
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x20 0x01 # 2001

# errata 2, transmit
# port 1
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x04 # reg 04
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0xD0 # 00D0

# port 2
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x04 # reg 04
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x1C # MMD 1C
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0xD0 # 00D0

# errata 4, diable EEE

i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x00 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x3C # reg 3C
i2ctransfer -y 8 w4@0x5F 0x11 0x1A 0x40 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x11 0x1C 0x00 0x00 # 0000

i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x00 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x3C # reg 3C
i2ctransfer -y 8 w4@0x5F 0x21 0x1A 0x40 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x21 0x1C 0x00 0x00 # 0000

i2ctransfer -y 8 w4@0x5F 0x31 0x1A 0x00 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x31 0x1C 0x00 0x3C # reg 3C
i2ctransfer -y 8 w4@0x5F 0x31 0x1A 0x40 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x31 0x1C 0x00 0x00 # 0000

i2ctransfer -y 8 w4@0x5F 0x41 0x1A 0x00 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x41 0x1C 0x00 0x3C # reg 3C
i2ctransfer -y 8 w4@0x5F 0x41 0x1A 0x40 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x41 0x1C 0x00 0x00 # 0000

i2ctransfer -y 8 w4@0x5F 0x51 0x1A 0x00 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x51 0x1C 0x00 0x3C # reg 3C
i2ctransfer -y 8 w4@0x5F 0x51 0x1A 0x40 0x07 # MMD 07
i2ctransfer -y 8 w4@0x5F 0x51 0x1C 0x00 0x00 # 0000

# reset PHY
i2ctransfer -y 8 w4@0x5F 0x11 0x00 0x91 0x40
i2ctransfer -y 8 w4@0x5F 0x21 0x00 0x91 0x40
i2ctransfer -y 8 w4@0x5F 0x31 0x00 0x91 0x40
i2ctransfer -y 8 w4@0x5F 0x41 0x00 0x91 0x40
i2ctransfer -y 8 w4@0x5F 0x51 0x00 0x91 0x40

# setup PTP

# setup PTP

# gobal enable
i2ctransfer -y 8 w4@0x5F 0x05 0x00 0x00 0x02

# PTP config 1
# 802.1as off, 1588 on, 802.3 ptp on, udp4 ptp on, udp6 ptpon, e2e mode, slave, one step
i2ctransfer -y 8 w4@0x5F 0x05 0x14 0x00 0x79

# ptp2, domain 0
i2ctransfer -y 8 w4@0x5F 0x05 0x18 0x02 0x00


# unicast on
# i2ctransfer -y 8 w2@0x5F 0x05 0x16 w2@0x5F 0x00 0x79

# read time
i2ctransfer -y 8 w4@0x5F 0x05 0x00 0x00 0x0B
i2ctransfer -y 8 w2@0x5F 0x05 0x04 r8